<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gestiona tus comidas y controla tus macronutrientes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NutriTrack">
    <title>Seguimiento Nutricional - PWA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 5px;
        }

        @media (min-width: 750px) {
            body {
                padding: 20px;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1em;
        }

        .pwa-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .header {
                padding: 30px;
            }
            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            .header p {
                font-size: 1em;
            }
            .pwa-badge {
                font-size: 0.8em;
            }
        }

        .install-prompt {
            background: #28a745;
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .install-prompt button {
            background: white;
            color: #28a745;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            flex: 1;
            min-width: 85px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.85em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            line-height: 1.2;
        }

        @media (min-width: 750px) {
            .tab {
                padding: 20px;
                font-size: 1.1em;
                min-width: auto;
                flex-direction: row;
                gap: 8px;
            }
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 4px solid #667eea;
        }

        .content {
            padding: 18px;
        }

        @media (min-width: 768px) {
            .content {
                padding: 30px;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.05em;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .alimento-search-container {
            position: relative;
            width: 100%;
        }

        .alimento-search-input {
            width: 100%;
            padding: 14px;
            padding-right: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.05em;
            transition: border 0.3s;
        }

        .alimento-search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .alimento-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            pointer-events: none;
        }

        .alimento-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            margin-top: -8px;
        }

        .alimento-dropdown.show {
            display: block;
        }

        .alimento-option {
            padding: 14px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .alimento-option:hover {
            background: #f8f9ff;
        }

        .alimento-option:last-child {
            border-bottom: none;
        }

        .alimento-option-nombre {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .alimento-option-info {
            font-size: 0.85em;
            color: #666;
        }

        .alimento-no-results {
            padding: 12px;
            text-align: center;
            color: #999;
        }

        .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 8px;
            margin-top: 8px;
        }

        @media (min-width: 768px) {
            .btn {
                padding: 12px 30px;
                font-size: 1em;
                margin-right: 10px;
                margin-top: 10px;
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em;
        }

        @media (min-width: 768px) {
            .table-container {
                margin-top: 20px;
            }
            table {
                min-width: auto;
            }
            th {
                padding: 15px;
                font-size: 1em;
            }
            td {
                padding: 12px 15px;
                font-size: 1em;
            }
        }

        tr:hover {
            background: #f8f9fa;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 14px;
            font-size: 1.3em;
        }

        @media (min-width: 768px) {
            .card {
                padding: 25px;
                margin-bottom: 20px;
            }
            .card h3 {
                margin-bottom: 15px;
                font-size: 1.5em;
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        @media (min-width: 768px) {
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.85em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card p {
            font-size: 1.5em;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 20px;
            }
            .stat-card h4 {
                font-size: 0.9em;
                margin-bottom: 10px;
            }
            .stat-card p {
                font-size: 2em;
            }
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group > div {
            flex: 1;
            min-width: 140px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
        }

        @media (min-width: 768px) {
            .filter-group {
                gap: 15px;
                margin-bottom: 20px;
            }
            .filter-group label {
                font-size: 1em;
            }
            .filter-group input,
            .filter-group select {
                padding: 10px;
                font-size: 1em;
            }
        }

        #chartContainer {
            height: 250px;
            margin-top: 15px;
        }

        @media (min-width: 768px) {
            #chartContainer {
                height: 400px;
                margin-top: 20px;
            }
        }

        .comida-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .comida-item strong {
            font-size: 1em;
        }

        .comida-item small {
            font-size: 0.85em;
        }

        @media (min-width: 768px) {
            .comida-item {
                padding: 15px;
                margin-bottom: 10px;
            }
            .comida-item strong {
                font-size: 1em;
            }
            .comida-item small {
                font-size: 0.875em;
            }
        }

        .comida-info {
            flex: 1;
        }

        .comida-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .grid-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .grid-form {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .action-buttons {
                gap: 10px;
            }
        }

        .small-btn {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .summary-table {
            margin-top: 20px;
            width: 100%;
        }

        /* Cards para m√≥vil en lugar de tabla */
        .detalle-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .detalle-card.ejercicio {
            background: #fff5f5;
            border-left-color: #ff6b6b;
        }

        .detalle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .detalle-card-title {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .detalle-card.ejercicio .detalle-card-title {
            color: #ff6b6b;
        }

        .detalle-card-momento {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .detalle-card.ejercicio .detalle-card-momento {
            background: #ff6b6b;
        }

        .detalle-card-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            font-size: 0.95em;
        }

        .detalle-card-info-item {
            display: flex;
            justify-content: space-between;
        }

        .detalle-card-info-label {
            color: #666;
        }

        .detalle-card-info-value {
            font-weight: 600;
            color: #333;
        }

        .detalle-card-actions {
            margin-top: 10px;
            text-align: right;
        }

        /* Ocultar tabla en m√≥vil, mostrar cards */
        @media (max-width: 767px) {
            .summary-table {
                display: none;
            }
        }

        /* Ocultar cards en desktop, mostrar tabla */
        @media (min-width: 768px) {
            .detalle-cards {
                display: none;
            }
        }

        .date-header {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .offline-indicator {
            background: #dc3545;
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 0.85em;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        /* Modal para gesti√≥n de localStorage */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 600px;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .modal-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">
        ‚ö†Ô∏è Sin conexi√≥n - Modo offline
    </div>

    <div class="install-prompt" id="installPrompt">
        <div>üì± Instala esta app en tu dispositivo para acceso r√°pido</div>
        <button onclick="instalarApp()">Instalar</button>
        <button onclick="cerrarInstall()" style="background: transparent; color: white;">‚úï</button>
    </div>

    <div class="container">
        <div class="header">
            <div class="pwa-badge">PWA</div>
            <h1>üçΩÔ∏è Seguimiento Nutricional</h1>
            <p>Gestiona tus comidas y controla tus macronutrientes</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('diario')">üìÖ Diario</button>
            <button class="tab" onclick="switchTab('estadisticas')">üìä Estad√≠sticas</button>
            <button class="tab" onclick="switchTab('alimentos')">üìã Alimentos</button>
            <button class="tab" onclick="switchTab('configuracion')">‚öôÔ∏è Config</button>
        </div>

        <div class="content">


            <!-- TAB 2: Diario de Comidas -->
            <div id="diario" class="tab-content active">
                <div class="card">
                    <h3>A√±adir Comida del D√≠a</h3>
                    <form id="formComidaDia" class="grid-form">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="fechaComida" required>
                        </div>
                        <div class="form-group">
                            <label>Alimento</label>
                            <div class="alimento-search-container">
                                <input type="text" 
                                       id="alimentoSearchInput" 
                                       class="alimento-search-input" 
                                       placeholder="Buscar alimento..."
                                       autocomplete="off"
                                       required>
                                <span class="alimento-search-icon">üîç</span>
                                <div id="alimentoDropdown" class="alimento-dropdown"></div>
                                <input type="hidden" id="alimentoSelect" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cantidad (gramos)</label>
                            <input type="number" id="cantidadComida" step="0.1" value="100" required>
                        </div>
                        <div class="form-group">
                            <label>Momento del d√≠a</label>
                            <select id="momentoDia" required>
                                <option value="Desayuno">Desayuno</option>
                                <option value="Media ma√±ana">Media ma√±ana</option>
                                <option value="Comida">Comida</option>
                                <option value="Merienda">Merienda</option>
                                <option value="Cena">Cena</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </form>
                    <button class="btn btn-primary" onclick="agregarComidaDia()">‚ûï A√±adir Comida</button>
                </div>

                <div class="card">
                    <h3>Registrar Calor√≠as Quemadas</h3>
                    <form id="formActividad" class="grid-form">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="fechaActividad" required>
                        </div>
                        <div class="form-group">
                            <label>Calor√≠as Quemadas</label>
                            <input type="number" id="caloriasQuemadas" step="1" value="200" required>
                        </div>
                    </form>
                    <button class="btn btn-success" onclick="agregarActividad()">üî• A√±adir Calor√≠as Quemadas</button>
                </div>

                <div class="card">
                    <h3>Resumen del D√≠a</h3>
                    <div class="form-group">
                        <label>Seleccionar Fecha</label>
                        <input type="date" id="fechaResumen" onchange="actualizarResumenDia()">
                    </div>
                    <div class="stats" id="statsResumen"></div>
                    <div id="detalleComidas"></div>
                </div>

                <div class="card">
                    <h3>Comidas Recientes</h3>
                    <div id="comidasRecientes"></div>
                </div>
            </div>

            <!-- TAB 3: Estad√≠sticas -->
            <div id="estadisticas" class="tab-content">
                <div class="card">
                    <h3>Filtros</h3>
                    <div class="filter-group">
                        <div>
                            <label>Desde:</label>
                            <input type="date" id="filtroDesde" onchange="actualizarDatosEstadisticas()()">
                        </div>
                        <div>
                            <label>Hasta:</label>
                            <input type="date" id="filtroHasta" onchange="actualizarDatosEstadisticas()()">
                        </div>
                        <div>
                            <label>Periodo:</label>
                            <select id="filtroPeriodo" onchange="aplicarFiltroPeriodo()">
                                <option value="7">√öltima semana</option>
                                <option value="30">√öltimo mes</option>
                                <option value="90">√öltimos 3 meses</option>
                            </select>
                        </div>
                        <div>
                            <label>M√©trica:</label>
                            <select id="filtroMetrica" onchange="actualizarGraficas()">
                                <option value="calorias">Calor√≠as Consumidas</option>
                                <option value="caloriasQuemadas">Calor√≠as Quemadas</option>
                                <option value="balance">Balance Cal√≥rico</option>
                                <option value="proteinas">Prote√≠nas</option>
                                <option value="grasas">Grasas</option>
                                <option value="hidratos">Hidratos</option>
                            </select>
                        </div>
                    </div>
                    <!-- Botones movidos a Configuraci√≥n -->
                </div>

                <div class="card">
                    <h3>Gr√°fica Hist√≥rica</h3>
                    <div id="chartContainer">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>Estad√≠sticas Generales</h3>
                    <div class="stats" id="statsGenerales"></div>
                </div>
            </div>

            <!-- TAB 1: Gesti√≥n de Alimentos -->
            <div id="alimentos" class="tab-content">
                <div class="card">
                    <h3>A√±adir/Editar Alimento</h3>
                    <form id="formAlimento" class="grid-form">
                        <input type="hidden" id="editIndex" value="">
                        <div class="form-group">
                            <label>Nombre del Alimento</label>
                            <input type="text" id="nombreAlimento" required>
                        </div>
                        <div class="form-group">
                            <label>Peso por raci√≥n (g)</label>
                            <input type="number" id="pesoAlimento" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Calor√≠as (kcal)</label>
                            <input type="number" id="caloriasAlimento" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Grasas (g)</label>
                            <input type="number" id="grasasAlimento" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Prote√≠nas (g)</label>
                            <input type="number" id="proteinasAlimento" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Hidratos (g)</label>
                            <input type="number" id="hidratosAlimento" step="0.1" required>
                        </div>
                    </form>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="guardarAlimento()">üíæ Guardar Alimento</button>
                        <button class="btn btn-warning" onclick="cancelarEdicion()">‚ùå Cancelar</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Lista de Alimentos</h3>
                    <!-- Botones movidos a Configuraci√≥n -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Peso (g)</th>
                                    <th>Calor√≠as</th>
                                    <th>Grasas (g)</th>
                                    <th>Prote√≠nas (g)</th>
                                    <th>Hidratos (g)</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="listaAlimentos"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 4: Configuraci√≥n -->
            <div id="configuracion" class="tab-content">
                <div class="card">
                    <h3>‚öôÔ∏è Configuraci√≥n Personal</h3>
                    <form class="grid-form">
                        <div class="form-group">
                            <label>Peso Corporal (kg)</label>
                            <input type="number" id="pesoUsuario" step="0.1" placeholder="75" onchange="guardarConfiguracion()">
                        </div>
                        <div class="form-group">
                            <label>Objetivo Prote√≠nas (g/kg)</label>
                            <input type="number" id="objetivoProteinas" step="0.1" placeholder="2.0" onchange="guardarConfiguracion()">
                        </div>
                        <div class="form-group">
                            <label>Objetivo Grasas (g/kg)</label>
                            <input type="number" id="objetivoGrasas" step="0.1" placeholder="1.0" onchange="guardarConfiguracion()">
                        </div>
                        <div class="form-group">
                            <label>Objetivo Hidratos (g/kg)</label>
                            <input type="number" id="objetivoHidratos" step="0.1" placeholder="3.0" onchange="guardarConfiguracion()">
                        </div>
                    </form>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <div id="objetivosCalculados" style="color: #495057;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìÇ Gesti√≥n de Datos</h3>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="abrirGestionDatos()">üîß Ver/Editar localStorage</button>
                        <button class="btn btn-success" onclick="exportarAlimentos()">üì• Exportar Alimentos</button>
                        <button class="btn btn-primary" onclick="importarAlimentos()">üì§ Importar Alimentos</button>
                        <button class="btn btn-success" onclick="exportarHistorico()">üì• Exportar Hist√≥rico</button>
                        <button class="btn btn-primary" onclick="importarHistorico()">üì§ Importar Hist√≥rico</button>
                    </div>
                </div>

                <div class="card">
                    <h3>‚ÑπÔ∏è Informaci√≥n</h3>
                    <p style="margin-bottom: 10px;"><strong>Versi√≥n:</strong> 1.0 PWA</p>
                    <p style="margin-bottom: 10px;"><strong>Datos guardados en:</strong> localStorage del navegador</p>
                    <p style="margin-bottom: 10px;"><strong>Alimentos:</strong> <span id="contadorAlimentos">0</span></p>
                    <p style="margin-bottom: 10px;"><strong>Comidas registradas:</strong> <span id="contadorHistorico">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para gesti√≥n de datos de localStorage -->
    <div id="modalDatos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0; color: #667eea;">üîß Gesti√≥n de Datos</h3>
                <span class="modal-close" onclick="cerrarGestionDatos()">&times;</span>
            </div>
            <div>
                <h4>Hist√≥rico de Comidas</h4>
                <textarea id="textareaHistorico" placeholder="Datos en formato JSON..."></textarea>
                <div class="action-buttons" style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="guardarHistoricoManual()">üíæ Guardar Cambios</button>
                    <button class="btn btn-success" onclick="copiarHistorico()">üìã Copiar</button>
                    <button class="btn btn-danger" onclick="borrarTodoHistorico()">üóëÔ∏è Borrar Todo</button>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <h4>Alimentos</h4>
                <textarea id="textareaAlimentos" placeholder="Datos en formato JSON..."></textarea>
                <div class="action-buttons" style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="guardarAlimentosManual()">üíæ Guardar Cambios</button>
                    <button class="btn btn-success" onclick="copiarAlimentos()">üìã Copiar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === PWA Service Worker Registration ===
        let deferredPrompt;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(reg => console.log('‚úÖ Service Worker registrado', reg))
                .catch(err => console.log('‚ùå Error al registrar Service Worker', err));
        }

        // Detectar cuando la app se puede instalar
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'flex';
        });

        function instalarApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ App instalada');
                    }
                    deferredPrompt = null;
                    cerrarInstall();
                });
            }
        }

        function cerrarInstall() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // Detectar conexi√≥n/desconexi√≥n
        window.addEventListener('online', () => {
            document.getElementById('offlineIndicator').classList.remove('show');
        });

        window.addEventListener('offline', () => {
            document.getElementById('offlineIndicator').classList.add('show');
        });

        // Variables globales
        let alimentos = [];
        let historico = [];
        let chart = null;
        let configuracion = {
            peso: 75,
            objetivoProteinas: 2.0,
            objetivoGrasas: 1.0,
            objetivoHidratos: 3.0
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            cargarConfiguracion();
            document.getElementById('fechaComida').valueAsDate = new Date();
            document.getElementById('fechaActividad').valueAsDate = new Date();
            document.getElementById('fechaResumen').valueAsDate = new Date();
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('filtroHasta').value = hoy;
            const hace30Dias = new Date();
            hace30Dias.setDate(hace30Dias.getDate() - 30);
            document.getElementById('filtroDesde').value = hace30Dias.toISOString().split('T')[0];
            
            // Cargar tab Diario por defecto
            actualizarSelectAlimentos();
            actualizarResumenDia();
            mostrarComidasRecientes();
        });

        // Gesti√≥n de tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'diario') {
                actualizarSelectAlimentos();
                actualizarResumenDia();
                mostrarComidasRecientes();
            } else if (tabName === 'estadisticas') {
                aplicarFiltroPeriodo();
            } else if (tabName === 'alimentos') {
                mostrarAlimentos();
            } else if (tabName === 'configuracion') {
                actualizarContadores();
            }
        }

        // ===== GESTI√ìN DE ALIMENTOS =====
        function guardarAlimento() {
            const nombre = document.getElementById('nombreAlimento').value.trim();
            const peso = parseFloat(document.getElementById('pesoAlimento').value);
            const calorias = parseFloat(document.getElementById('caloriasAlimento').value);
            const grasas = parseFloat(document.getElementById('grasasAlimento').value);
            const proteinas = parseFloat(document.getElementById('proteinasAlimento').value);
            const hidratos = parseFloat(document.getElementById('hidratosAlimento').value);
            const editIndex = document.getElementById('editIndex').value;

            if (!nombre) {
                alert('Por favor, completa todos los campos');
                return;
            }

            const alimento = { nombre, peso, calorias, grasas, proteinas, hidratos };

            if (editIndex !== '') {
                alimentos[parseInt(editIndex)] = alimento;
            } else {
                alimentos.push(alimento);
            }

            guardarDatos();
            mostrarAlimentos();
            limpiarFormularioAlimento();
        }

        function editarAlimento(index) {
            const alimento = alimentos[index];
            document.getElementById('nombreAlimento').value = alimento.nombre;
            document.getElementById('pesoAlimento').value = alimento.peso;
            document.getElementById('caloriasAlimento').value = alimento.calorias;
            document.getElementById('grasasAlimento').value = alimento.grasas;
            document.getElementById('proteinasAlimento').value = alimento.proteinas;
            document.getElementById('hidratosAlimento').value = alimento.hidratos;
            document.getElementById('editIndex').value = index;
            window.scrollTo(0, 0);
        }

        function eliminarAlimento(index) {
            if (confirm('¬øEst√°s seguro de eliminar este alimento?')) {
                alimentos.splice(index, 1);
                guardarDatos();
                mostrarAlimentos();
            }
        }

        function cancelarEdicion() {
            limpiarFormularioAlimento();
        }

        function limpiarFormularioAlimento() {
            document.getElementById('formAlimento').reset();
            document.getElementById('editIndex').value = '';
        }

        function mostrarAlimentos() {
            const tbody = document.getElementById('listaAlimentos');
            tbody.innerHTML = '';

            alimentos.forEach((alimento, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${alimento.nombre}</td>
                    <td>${alimento.peso.toFixed(1)}</td>
                    <td>${alimento.calorias.toFixed(1)}</td>
                    <td>${alimento.grasas.toFixed(1)}</td>
                    <td>${alimento.proteinas.toFixed(1)}</td>
                    <td>${alimento.hidratos.toFixed(1)}</td>
                    <td>
                        <button class="btn btn-warning small-btn" onclick="editarAlimento(${index})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger small-btn" onclick="eliminarAlimento(${index})">üóëÔ∏è Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== DIARIO DE COMIDAS =====
        let alimentosOrdenados = [];

        function actualizarSelectAlimentos() {
            // Crear un array con los √≠ndices originales y ordenarlo alfab√©ticamente
            alimentosOrdenados = alimentos
                .map((alimento, index) => ({ alimento, index }))
                .sort((a, b) => a.alimento.nombre.localeCompare(b.alimento.nombre));
            
            // Configurar el buscador de alimentos
            const searchInput = document.getElementById('alimentoSearchInput');
            const dropdown = document.getElementById('alimentoDropdown');
            const hiddenSelect = document.getElementById('alimentoSelect');
            
            // Mostrar dropdown al hacer foco
            searchInput.addEventListener('focus', () => {
                mostrarAlimentosDropdown('');
            });
            
            // Filtrar mientras se escribe
            searchInput.addEventListener('input', (e) => {
                mostrarAlimentosDropdown(e.target.value);
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.alimento-search-container')) {
                    dropdown.classList.remove('show');
                }
            });
        }
        
        function mostrarAlimentosDropdown(filtro) {
            const dropdown = document.getElementById('alimentoDropdown');
            const searchInput = document.getElementById('alimentoSearchInput');
            const hiddenSelect = document.getElementById('alimentoSelect');
            
            const filtroLower = filtro.toLowerCase();
            const alimentosFiltrados = alimentosOrdenados.filter(({ alimento }) => 
                alimento.nombre.toLowerCase().includes(filtroLower)
            );
            
            if (alimentosFiltrados.length === 0) {
                dropdown.innerHTML = '<div class="alimento-no-results">No se encontraron alimentos</div>';
            } else {
                dropdown.innerHTML = alimentosFiltrados.map(({ alimento, index }) => `
                    <div class="alimento-option" data-index="${index}">
                        <div class="alimento-option-nombre">${alimento.nombre}</div>
                        <div class="alimento-option-info">${alimento.peso}g - ${alimento.calorias}kcal</div>
                    </div>
                `).join('');
                
                // A√±adir event listeners a las opciones
                dropdown.querySelectorAll('.alimento-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const index = option.getAttribute('data-index');
                        const alimento = alimentos[index];
                        searchInput.value = alimento.nombre;
                        hiddenSelect.value = index;
                        dropdown.classList.remove('show');
                    });
                });
            }
            
            dropdown.classList.add('show');
        }

        function agregarActividad() {
            const fecha = document.getElementById('fechaActividad').value;
            const calorias = parseInt(document.getElementById('caloriasQuemadas').value);

            if (!fecha || !calorias) {
                alert('Por favor, completa todos los campos');
                return;
            }

            const comida = {
                fecha,
                momento: 'Ejercicio',
                alimento: 'Calor√≠as Quemadas',
                cantidad: calorias,
                calorias: -calorias,
                grasas: 0,
                proteinas: 0,
                hidratos: 0,
                peso: 1,
                timestamp: new Date().toISOString()
            };

            historico.push(comida);
            guardarDatos();
            
            alert('‚úÖ Calor√≠as quemadas a√±adidas correctamente');
            document.getElementById('formActividad').reset();
            document.getElementById('fechaActividad').valueAsDate = new Date();
            document.getElementById('caloriasQuemadas').value = 200;
            
            actualizarResumenDia();
            mostrarComidasRecientes();
        }

        function agregarComidaDia() {
            const fecha = document.getElementById('fechaComida').value;
            const alimentoIndex = document.getElementById('alimentoSelect').value;
            const cantidadGramos = parseFloat(document.getElementById('cantidadComida').value);
            const momento = document.getElementById('momentoDia').value;

            if (!fecha || alimentoIndex === '' || !cantidadGramos) {
                alert('Por favor, completa todos los campos');
                return;
            }

            const alimento = alimentos[alimentoIndex];
            const factor = cantidadGramos / alimento.peso;
            
            const comida = {
                fecha,
                momento,
                alimento: alimento.nombre,
                cantidad: cantidadGramos,
                calorias: alimento.calorias * factor,
                grasas: alimento.grasas * factor,
                proteinas: alimento.proteinas * factor,
                hidratos: alimento.hidratos * factor,
                peso: cantidadGramos,
                timestamp: new Date().toISOString()
            };

            historico.push(comida);
            guardarDatos();
            
            alert('‚úÖ Comida a√±adida correctamente');
            document.getElementById('formComidaDia').reset();
            document.getElementById('fechaComida').valueAsDate = new Date();
            document.getElementById('cantidadComida').value = 100;
            
            actualizarResumenDia();
            mostrarComidasRecientes();
        }

        function actualizarResumenDia() {
            const fecha = document.getElementById('fechaResumen').value;
            const comidasDelDia = historico.filter(c => c.fecha === fecha);

            let totalCalorias = 0, totalGrasas = 0, totalProteinas = 0, totalHidratos = 0;
            let totalCaloriasConsumidas = 0, totalCaloriasQuemadas = 0;

            comidasDelDia.forEach(comida => {
                if (comida.calorias >= 0) {
                    totalCaloriasConsumidas += comida.calorias;
                    totalCalorias += comida.calorias;
                    totalGrasas += comida.grasas;
                    totalProteinas += comida.proteinas;
                    totalHidratos += comida.hidratos;
                } else {
                    totalCaloriasQuemadas += Math.abs(comida.calorias);
                }
            });

            const balance = totalCaloriasConsumidas - totalCaloriasQuemadas;

            const statsDiv = document.getElementById('statsResumen');
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <h4>Calor√≠as Consumidas</h4>
                    <p>${totalCaloriasConsumidas.toFixed(0)} kcal</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                    <h4>Calor√≠as Quemadas</h4>
                    <p>${totalCaloriasQuemadas.toFixed(0)} kcal</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, ${balance >= 0 ? '#ffc107, #ffb300' : '#28a745, #20c997'});">
                    <h4>Balance Cal√≥rico</h4>
                    <p>${balance > 0 ? '+' : ''}${balance.toFixed(0)} kcal</p>
                </div>
                <div class="stat-card">
                    <h4>Prote√≠nas</h4>
                    <p>${totalProteinas.toFixed(1)} g</p>
                </div>
                <div class="stat-card">
                    <h4>Grasas</h4>
                    <p>${totalGrasas.toFixed(1)} g</p>
                </div>
                <div class="stat-card">
                    <h4>Hidratos</h4>
                    <p>${totalHidratos.toFixed(1)} g</p>
                </div>
            `;

            const detalleDiv = document.getElementById('detalleComidas');
            if (comidasDelDia.length > 0) {
                // Version cards para m√≥vil
                const cardsHTML = `
                    <h4 style="margin-top: 20px; color: #667eea;">Detalle de comidas del d√≠a</h4>
                    <div class="detalle-cards">
                        ${comidasDelDia.map((comida) => {
                            const esEjercicio = comida.calorias < 0;
                            return `
                            <div class="detalle-card ${esEjercicio ? 'ejercicio' : ''}">
                                <div class="detalle-card-header">
                                    <div class="detalle-card-title">${comida.alimento}</div>
                                    <div class="detalle-card-momento">${comida.momento}</div>
                                </div>
                                <div class="detalle-card-info">
                                    <div class="detalle-card-info-item">
                                        <span class="detalle-card-info-label">Cantidad:</span>
                                        <span class="detalle-card-info-value">${esEjercicio ? Math.abs(comida.cantidad) + ' kcal' : comida.cantidad.toFixed(1) + 'g'}</span>
                                    </div>
                                    <div class="detalle-card-info-item">
                                        <span class="detalle-card-info-label">Calor√≠as:</span>
                                        <span class="detalle-card-info-value">${esEjercicio ? '-' : ''}${Math.abs(comida.calorias).toFixed(0)} kcal</span>
                                    </div>
                                    ${!esEjercicio ? `
                                    <div class="detalle-card-info-item">
                                        <span class="detalle-card-info-label">Prote√≠nas:</span>
                                        <span class="detalle-card-info-value">${comida.proteinas.toFixed(1)}g</span>
                                    </div>
                                    <div class="detalle-card-info-item">
                                        <span class="detalle-card-info-label">Grasas:</span>
                                        <span class="detalle-card-info-value">${comida.grasas.toFixed(1)}g</span>
                                    </div>
                                    <div class="detalle-card-info-item">
                                        <span class="detalle-card-info-label">Hidratos:</span>
                                        <span class="detalle-card-info-value">${comida.hidratos.toFixed(1)}g</span>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="detalle-card-actions">
                                    <button class="btn btn-danger small-btn" onclick="eliminarComida('${fecha}', ${historico.indexOf(comida)})">üóëÔ∏è Eliminar</button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;

                // Version tabla para desktop
                const tablaHTML = `
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Momento</th>
                                <th>Alimento</th>
                                <th>Cantidad</th>
                                <th>Calor√≠as</th>
                                <th>Prote√≠nas</th>
                                <th>Grasas</th>
                                <th>Hidratos</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${comidasDelDia.map((comida, idx) => {
                                const esEjercicio = comida.calorias < 0;
                                return `
                                <tr style="${esEjercicio ? 'background: #fff5f5;' : ''}">
                                    <td>${comida.momento}</td>
                                    <td style="${esEjercicio ? 'color: #ff6b6b; font-weight: bold;' : ''}">${comida.alimento}</td>
                                    <td>${esEjercicio ? Math.abs(comida.cantidad) : comida.cantidad.toFixed(1)}${esEjercicio ? ' kcal' : 'g'}</td>
                                    <td style="${esEjercicio ? 'color: #ff6b6b;' : ''}">${esEjercicio ? '' : Math.abs(comida.calorias).toFixed(0)} ${esEjercicio ? '-' + Math.abs(comida.calorias).toFixed(0) : ''} kcal</td>
                                    <td>${esEjercicio ? '-' : comida.proteinas.toFixed(1) + ' g'}</td>
                                    <td>${esEjercicio ? '-' : comida.grasas.toFixed(1) + ' g'}</td>
                                    <td>${esEjercicio ? '-' : comida.hidratos.toFixed(1) + ' g'}</td>
                                    <td>
                                        <button class="btn btn-danger small-btn" onclick="eliminarComida('${fecha}', ${historico.indexOf(comida)})">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `;

                detalleDiv.innerHTML = cardsHTML + tablaHTML;
            } else {
                detalleDiv.innerHTML = '<p style="margin-top: 20px; text-align: center; color: #999;">No hay comidas registradas para este d√≠a</p>';
            }
        }

        function eliminarComida(fecha, index) {
            if (confirm('¬øEliminar esta comida?')) {
                historico.splice(index, 1);
                guardarDatos();
                actualizarResumenDia();
                mostrarComidasRecientes();
                // actualizarGraficas();
            }
        }

        function mostrarComidasRecientes() {
            const div = document.getElementById('comidasRecientes');
            const recientes = [...historico].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);

            if (recientes.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #999;">No hay comidas registradas</p>';
                return;
            }

            div.innerHTML = recientes.map(comida => {
                const esEjercicio = comida.calorias < 0;
                return `
                <div class="comida-item" style="${esEjercicio ? 'background: #fff5f5; border-left: 4px solid #ff6b6b;' : ''}">
                    <div class="comida-info">
                        <strong style="${esEjercicio ? 'color: #ff6b6b;' : ''}">${comida.alimento}</strong> ${esEjercicio ? '(' + Math.abs(comida.cantidad) + ' kcal)' : '(' + comida.cantidad.toFixed(1) + 'g)'}
                        <br>
                        <small>${comida.fecha} - ${comida.momento}</small>
                        <br>
                        <small>${esEjercicio ? '-' : ''}${Math.abs(comida.calorias).toFixed(0)} kcal${esEjercicio ? '' : ' | P: ' + comida.proteinas.toFixed(1) + 'g | G: ' + comida.grasas.toFixed(1) + 'g | H: ' + comida.hidratos.toFixed(1) + 'g'}</small>
                    </div>
                </div>
            `}).join('');
        }

        // ===== ESTAD√çSTICAS =====
        function aplicarFiltroPeriodo() {
            const periodo = document.getElementById('filtroPeriodo').value;
            if (!periodo) return;

            const hoy = new Date();
            const desde = new Date();
            desde.setDate(hoy.getDate() - parseInt(periodo));

            document.getElementById('filtroDesde').value = desde.toISOString().split('T')[0];
            document.getElementById('filtroHasta').value = hoy.toISOString().split('T')[0];
            actualizarDatosEstadisticas();
        }
        
        function actualizarDatosEstadisticas() {
            actualizarGraficas();
            actualizarEstadisticasGenerales();
        }
        
        function actualizarGraficas() {
            const desde = document.getElementById('filtroDesde').value;
            const hasta = document.getElementById('filtroHasta').value;
            const metrica = document.getElementById('filtroMetrica').value;

            const datosFiltrados = historico.filter(c => c.fecha >= desde && c.fecha <= hasta);

            const datosPorFecha = {};
            datosFiltrados.forEach(comida => {
                if (!datosPorFecha[comida.fecha]) {
                    datosPorFecha[comida.fecha] = { calorias: 0, proteinas: 0, grasas: 0, hidratos: 0, caloriasQuemadas: 0 };
                }
                if (comida.calorias >= 0) {
                    datosPorFecha[comida.fecha].calorias += comida.calorias;
                    datosPorFecha[comida.fecha].proteinas += comida.proteinas;
                    datosPorFecha[comida.fecha].grasas += comida.grasas;
                    datosPorFecha[comida.fecha].hidratos += comida.hidratos;
                } else {
                    datosPorFecha[comida.fecha].caloriasQuemadas += Math.abs(comida.calorias);
                }
            });

            Object.keys(datosPorFecha).forEach(fecha => {
                datosPorFecha[fecha].balance = datosPorFecha[fecha].calorias - datosPorFecha[fecha].caloriasQuemadas;
            });

            const fechas = Object.keys(datosPorFecha).sort();
            const valores = fechas.map(fecha => datosPorFecha[fecha][metrica]);

            const ctx = document.getElementById('myChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const labels = {
                calorias: 'Calor√≠as Consumidas (kcal)',
                caloriasQuemadas: 'Calor√≠as Quemadas (kcal)',
                balance: 'Balance Cal√≥rico (kcal)',
                proteinas: 'Prote√≠nas (g)',
                grasas: 'Grasas (g)',
                hidratos: 'Hidratos (g)'
            };

            const colores = {
                calorias: '#667eea',
                caloriasQuemadas: '#ff6b6b',
                balance: '#28a745',
                proteinas: '#667eea',
                grasas: '#667eea',
                hidratos: '#667eea'
            };

            // Calcular l√≠nea de objetivo basada en la m√©trica
            const objetivos = {
                proteinas: configuracion.peso * configuracion.objetivoProteinas,
                grasas: configuracion.peso * configuracion.objetivoGrasas,
                hidratos: configuracion.peso * configuracion.objetivoHidratos
            };

            // Datasets para la gr√°fica
            const datasets = [{
                label: labels[metrica],
                data: valores,
                borderColor: colores[metrica] || '#667eea',
                backgroundColor: metrica === 'caloriasQuemadas' ? 'rgba(255, 107, 107, 0.1)' : metrica === 'balance' ? 'rgba(40, 167, 69, 0.1)' : 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }];

            // A√±adir l√≠nea de objetivo si es prote√≠nas, grasas o hidratos
            if (objetivos[metrica]) {
                const valorObjetivo = objetivos[metrica];
                datasets.push({
                    label: 'Objetivo (' + valorObjetivo.toFixed(0) + 'g)',
                    data: Array(fechas.length).fill(valorObjetivo),
                    borderColor: '#ffc107',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    fill: false,
                    pointRadius: 0,
                    tension: 0
                });
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fechas,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function actualizarEstadisticasGenerales() {
            // Obtener el rango de fechas seleccionado
            const desde = document.getElementById('filtroDesde').value;
            const hasta = document.getElementById('filtroHasta').value;
            
            // Filtrar comidas del periodo seleccionado
            const comidasPeriodo = historico.filter(c => c.fecha >= desde && c.fecha <= hasta);
            
            if (comidasPeriodo.length === 0) {
                document.getElementById('statsGenerales').innerHTML = '<p style="text-align: center; color: #999;">No hay datos en el periodo seleccionado</p>';
                return;
            }

            // Calcular totales separando consumo y ejercicio
            let totalCaloriasConsumidas = 0, totalCaloriasQuemadas = 0;
            let totalProteinas = 0, totalGrasas = 0, totalHidratos = 0;
            const fechasUnicas = new Set();

            comidasPeriodo.forEach(comida => {
                fechasUnicas.add(comida.fecha);
                if (comida.calorias >= 0) {
                    totalCaloriasConsumidas += comida.calorias;
                    totalProteinas += comida.proteinas;
                    totalGrasas += comida.grasas;
                    totalHidratos += comida.hidratos;
                } else {
                    totalCaloriasQuemadas += Math.abs(comida.calorias);
                }
            });

            const numDias = fechasUnicas.size;
            const balance = totalCaloriasConsumidas - totalCaloriasQuemadas;
            const promedioCaloriasConsumidas = totalCaloriasConsumidas / numDias;
            const promedioCaloriasQuemadas = totalCaloriasQuemadas / numDias;
            const promedioBalance = balance / numDias;
            const promedioProteinas = totalProteinas / numDias;
            const promedioGrasas = totalGrasas / numDias;
            const promedioHidratos = totalHidratos / numDias;

            document.getElementById('statsGenerales').innerHTML = `
                <div class="stat-card">
                    <h4>Promedio Calor√≠as Consumidas/d√≠a</h4>
                    <p>${promedioCaloriasConsumidas.toFixed(0)} kcal</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                    <h4>Promedio Calor√≠as Quemadas/d√≠a</h4>
                    <p>${promedioCaloriasQuemadas.toFixed(0)} kcal</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, ${promedioBalance >= 0 ? '#ffc107, #ffb300' : '#28a745, #20c997'});">
                    <h4>Promedio Balance Cal√≥rico/d√≠a</h4>
                    <p>${promedioBalance > 0 ? '+' : ''}${promedioBalance.toFixed(0)} kcal</p>
                </div>
                <div class="stat-card">
                    <h4>Promedio Prote√≠nas/d√≠a</h4>
                    <p>${promedioProteinas.toFixed(1)} g</p>
                </div>
                <div class="stat-card">
                    <h4>Promedio Grasas/d√≠a</h4>
                    <p>${promedioGrasas.toFixed(1)} g</p>
                </div>
                <div class="stat-card">
                    <h4>Promedio Hidratos/d√≠a</h4>
                    <p>${promedioHidratos.toFixed(1)} g</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #a8dadc 0%, #81c3d7 100%);">
                    <h4>D√≠as en periodo</h4>
                    <p>${numDias}</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #d4a5a5 0%, #c48c8c 100%);">
                    <h4>Total Comidas</h4>
                    <p>${comidasPeriodo.length}</p>
                </div>
            `;
        }

        // ===== PERSISTENCIA DE DATOS =====
        function guardarDatos() {
            localStorage.setItem('alimentos', JSON.stringify(alimentos));
            localStorage.setItem('historico', JSON.stringify(historico));
            mostrarAlimentos();
        }

        async function cargarDatos() {
            const alimentosGuardados = localStorage.getItem('alimentos');
            const historicoGuardado = localStorage.getItem('historico');

            if (alimentosGuardados) {
                alimentos = JSON.parse(alimentosGuardados);
                mostrarAlimentos();
            } else {
                try {
                    const response = await fetch('alimentos.json');
                    if (response.ok) {
                        alimentos = await response.json();
                        guardarDatos();
                        mostrarAlimentos();
                    }
                } catch (error) {
                    console.log('Cargando desde cache...');
                }
            }

            if (historicoGuardado) {
                historico = JSON.parse(historicoGuardado);
            } else {
                try {
                    const response = await fetch('historico_comidas.json');
                    if (response.ok) {
                        historico = await response.json();
                        guardarDatos();
                    }
                } catch (error) {
                    console.log('Cargando desde cache...');
                }
            }
        }

        // ===== IMPORTAR/EXPORTAR =====
        function exportarAlimentos() {
            const dataStr = JSON.stringify(alimentos, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'alimentos.json';
            link.click();
        }

        async function importarAlimentos() {
            try {
                const response = await fetch('alimentos.json');
                if (response.ok) {
                    const data = await response.json();
                    alimentos = data;
                    guardarDatos();
                    alert('‚úÖ Alimentos importados correctamente');
                    return;
                }
            } catch (error) {
                console.log('Abriendo selector...');
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        alimentos = JSON.parse(event.target.result);
                        guardarDatos();
                        alert('‚úÖ Alimentos importados correctamente');
                    } catch (error) {
                        alert('‚ùå Error al importar el archivo JSON');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportarHistorico() {
            const dataStr = JSON.stringify(historico, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'historico_comidas.json';
            link.click();
        }

        async function importarHistorico() {
            // Siempre abrir selector de archivos (m√°s confiable en m√≥vil)
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) {
                    alert('‚ÑπÔ∏è No se seleccion√≥ ning√∫n archivo');
                    return;
                }
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        historico = data;
                        guardarDatos();
                        // actualizarGraficas();
                        actualizarResumenDia();
                        mostrarComidasRecientes();
                        alert(`‚úÖ Hist√≥rico importado correctamente\n${historico.length} comidas cargadas`);
                    } catch (error) {
                        alert('‚ùå Error al importar el archivo JSON\n' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ===== GESTI√ìN DE DATOS EN LOCALSTORAGE =====
        function abrirGestionDatos() {
            document.getElementById('textareaHistorico').value = JSON.stringify(historico, null, 2);
            document.getElementById('textareaAlimentos').value = JSON.stringify(alimentos, null, 2);
            document.getElementById('modalDatos').style.display = 'block';
        }

        function cerrarGestionDatos() {
            document.getElementById('modalDatos').style.display = 'none';
        }

        function guardarHistoricoManual() {
            try {
                const texto = document.getElementById('textareaHistorico').value;
                const datos = JSON.parse(texto);
                historico = datos;
                guardarDatos();
                // actualizarGraficas();
                actualizarResumenDia();
                mostrarComidasRecientes();
                alert(`‚úÖ Hist√≥rico guardado correctamente\n${historico.length} comidas`);
            } catch (error) {
                alert('‚ùå Error en el formato JSON:\n' + error.message);
            }
        }

        function guardarAlimentosManual() {
            try {
                const texto = document.getElementById('textareaAlimentos').value;
                const datos = JSON.parse(texto);
                alimentos = datos;
                guardarDatos();
                alert(`‚úÖ Alimentos guardados correctamente\n${alimentos.length} alimentos`);
            } catch (error) {
                alert('‚ùå Error en el formato JSON:\n' + error.message);
            }
        }

        function copiarHistorico() {
            const textarea = document.getElementById('textareaHistorico');
            textarea.select();
            document.execCommand('copy');
            alert('üìã Hist√≥rico copiado al portapapeles');
        }

        function copiarAlimentos() {
            const textarea = document.getElementById('textareaAlimentos');
            textarea.select();
            document.execCommand('copy');
            alert('üìã Alimentos copiados al portapapeles');
        }

        function borrarTodoHistorico() {
            if (confirm('‚ö†Ô∏è ¬øSEGURO que quieres borrar TODO el hist√≥rico?\n\nEsta acci√≥n no se puede deshacer.')) {
                if (confirm('üö® √öLTIMA CONFIRMACI√ìN: Se borrar√°n ' + historico.length + ' comidas')) {
                    historico = [];
                    guardarDatos();
                    // actualizarGraficas();
                    actualizarResumenDia();
                    mostrarComidasRecientes();
                    document.getElementById('textareaHistorico').value = '[]';
                    alert('‚úÖ Hist√≥rico borrado completamente');
                }
            }
        }

        // ===== CONFIGURACI√ìN DEL USUARIO =====
        function guardarConfiguracion() {
            const peso = parseFloat(document.getElementById('pesoUsuario').value);
            const objProteinas = parseFloat(document.getElementById('objetivoProteinas').value);
            const objGrasas = parseFloat(document.getElementById('objetivoGrasas').value);
            const objHidratos = parseFloat(document.getElementById('objetivoHidratos').value);

            if (isNaN(peso) || peso <= 0) {
                alert('‚ö†Ô∏è Por favor, introduce un peso v√°lido');
                return;
            }
            if (isNaN(objProteinas) || objProteinas < 0) {
                alert('‚ö†Ô∏è Por favor, introduce un objetivo v√°lido para prote√≠nas');
                return;
            }
            if (isNaN(objGrasas) || objGrasas < 0) {
                alert('‚ö†Ô∏è Por favor, introduce un objetivo v√°lido para grasas');
                return;
            }
            if (isNaN(objHidratos) || objHidratos < 0) {
                alert('‚ö†Ô∏è Por favor, introduce un objetivo v√°lido para hidratos');
                return;
            }

            configuracion.peso = peso;
            configuracion.objetivoProteinas = objProteinas;
            configuracion.objetivoGrasas = objGrasas;
            configuracion.objetivoHidratos = objHidratos;

            localStorage.setItem('configuracion', JSON.stringify(configuracion));
            
            actualizarObjetivosCalculados();
            // actualizarGraficas(); // Actualizar gr√°ficas para mostrar nuevas l√≠neas objetivo
            
            alert('‚úÖ Configuraci√≥n guardada correctamente');
        }

        function cargarConfiguracion() {
            const configGuardada = localStorage.getItem('configuracion');
            if (configGuardada) {
                configuracion = JSON.parse(configGuardada);
            }

            // Cargar valores en los inputs
            document.getElementById('pesoUsuario').value = configuracion.peso;
            document.getElementById('objetivoProteinas').value = configuracion.objetivoProteinas;
            document.getElementById('objetivoGrasas').value = configuracion.objetivoGrasas;
            document.getElementById('objetivoHidratos').value = configuracion.objetivoHidratos;

            actualizarObjetivosCalculados();
        }

        function actualizarObjetivosCalculados() {
            const proteinasTotal = (configuracion.peso * configuracion.objetivoProteinas).toFixed(0);
            const grasasTotal = (configuracion.peso * configuracion.objetivoGrasas).toFixed(0);
            const hidratosTotal = (configuracion.peso * configuracion.objetivoHidratos).toFixed(0);

            document.getElementById('objetivosCalculados').innerHTML = `
                <p><strong>Objetivos diarios calculados (${configuracion.peso}kg):</strong></p>
                <ul>
                    <li>Prote√≠nas: <strong>${proteinasTotal}g</strong> (${configuracion.objetivoProteinas}g/kg)</li>
                    <li>Grasas: <strong>${grasasTotal}g</strong> (${configuracion.objetivoGrasas}g/kg)</li>
                    <li>Hidratos: <strong>${hidratosTotal}g</strong> (${configuracion.objetivoHidratos}g/kg)</li>
                </ul>
            `;
        }

        function actualizarContadores() {
            document.getElementById('contadorAlimentos').textContent = alimentos.length;
            document.getElementById('contadorHistorico').textContent = historico.length;
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modalDatos');
            if (event.target == modal) {
                cerrarGestionDatos();
            }
        }
    </script>
</body>
</html>
